# YOLO의 역할 설명

## ❌ 현재 구현: YOLO는 개별 셀을 감지하지 않음

### 현재 YOLO가 하는 일:

```
전체 문서 이미지
     ↓
[YOLO 감지]  ← 여기서 표 영역 전체를 하나의 객체로 감지
     ↓
표 영역 바운딩 박스
┌─────────────────────────────────┐
│                                 │
│   [전체 표 영역]                │
│   모든 셀을 포함하는             │
│   하나의 큰 직사각형             │
│                                 │
└─────────────────────────────────┘
     ↓
OCR로 넘김 (셀 구분은 OCR 후 좌표 분석)
```

### 출력 예시:
```python
# src/detection.py의 detect_tables() 결과:
[
    {
        "class": "table",
        "confidence": 0.95,
        "bbox": [100, 200, 800, 600],  # ← 표 전체 영역
        "bbox_norm": [0.1, 0.2, 0.8, 0.6]
    }
]
# 개별 셀 정보는 없음!
```

---

## 🔍 전체 처리 흐름

### **단계별 역할 분담:**

```
1. [YOLO] 표 영역 감지
   ┌──────────────────────────────┐
   │ 입력: 문서 전체 이미지        │
   │ 출력: 표 영역 좌표 (1개)     │
   │       [x1, y1, x2, y2]       │
   └──────────────────────────────┘
            ↓
2. [표 영역 크롭]
   표 영역만 잘라내기
            ↓
3. [OCR] 텍스트 추출 + 좌표
   ┌──────────────────────────────┐
   │ 입력: 표 영역 이미지          │
   │ 출력: 각 텍스트의 위치 좌표   │
   │                               │
   │ [                             │
   │   {"text": "항목",            │
   │    "center": [100, 50]},      │
   │   {"text": "규격",            │
   │    "center": [300, 50]},      │
   │   {"text": "철근",            │
   │    "center": [100, 100]},     │
   │   ...                         │
   │ ]                             │
   └──────────────────────────────┘
            ↓
4. [좌표 분석] 셀 구조 파악
   ┌──────────────────────────────┐
   │ Y 좌표 클러스터링 → 행 분류  │
   │ X 좌표 정렬 → 열 분류        │
   │                               │
   │ 행0: ["항목", "규격", "단위"]│
   │ 행1: ["철근", "D13", "ton"]  │
   │ 행2: ["콘크리트", "25MPa", "m³"]│
   └──────────────────────────────┘
            ↓
5. [파싱] 병합 셀 감지 + JSON 변환
```

---

## 💡 왜 YOLO로 셀을 감지하지 않는가?

### **이유 1: 학습 데이터 문제**
- YOLO11 기본 모델은 "table" 클래스만 학습됨
- 개별 셀을 감지하려면:
  - 수천 장의 표 이미지
  - 각 이미지의 모든 셀에 바운딩 박스 라벨링
  - 수백 시간의 라벨링 작업 필요

### **이유 2: 효율성 문제**
```
YOLO로 셀 감지 시:
- 10x5 표 = 50개 셀
- YOLO가 50개 객체 감지 필요
- 느리고 복잡함

OCR 기반 접근:
- OCR로 텍스트 위치 추출
- 좌표 분석으로 셀 구조 파악
- 빠르고 간단함
```

### **이유 3: 정확도 문제**
- 표 선이 흐릿하거나 없으면?
- 셀 경계가 불명확하면?
- YOLO로 셀 감지는 오류 가능성 높음
- OCR + 좌표 분석이 더 견고함

---

## 🤔 그렇다면 개별 셀 감지가 필요한가?

### **시나리오 비교:**

#### **현재 방식 (YOLO 표 전체 감지 + OCR 좌표 분석)**
```
장점:
✅ 구현 간단
✅ 학습 데이터 필요 최소
✅ 대부분의 정형 표에서 잘 작동
✅ 표 선이 없는 표도 처리 가능

단점:
❌ 열 경계가 불명확하면 어려움
❌ 불규칙한 표는 처리 어려움
```

#### **대안: YOLO로 셀까지 감지**
```
장점:
✅ 표 구조를 정확히 파악
✅ 셀 경계가 명확함
✅ 불규칙한 표도 처리 가능

단점:
❌ 대규모 라벨링 필요 (수천 장)
❌ 학습 시간 오래 걸림
❌ 추론 속도 느림 (객체 수 많음)
❌ 표 선이 흐릿하면 정확도 저하
```

---

## 🚀 개선 옵션

### **옵션 1: 현재 방식 개선 (추천) ⭐**
```python
# 열 경계 감지 알고리즘 추가
1. 헤더 기준 열 배정
2. X 좌표 히스토그램 분석
3. 표 선 검출 (OpenCV)

→ 현재 85% → 95% 커버리지 향상
→ 추가 학습 데이터 불필요
```

### **옵션 2: Table Structure Recognition 모델 사용**
```python
# 전용 표 구조 인식 모델
- Microsoft의 Table Transformer
- PubTabNet 데이터셋으로 학습된 모델
- 셀 구조까지 인식 가능

장점:
✅ 이미 학습된 모델 사용
✅ 셀 경계 정확히 인식

단점:
❌ 추가 모델 필요 (복잡도 증가)
❌ 속도 저하
❌ 한글 표 성능 검증 필요
```

### **옵션 3: YOLO 커스텀 학습 (비추천) ❌**
```python
# 셀까지 감지하도록 YOLO 재학습
필요 작업:
- 건설 시방서 표 1000+ 장 수집
- 각 표의 모든 셀 라벨링 (수만 개 셀)
- YOLO 학습 (수일~수주)

→ 비용 대비 효과 낮음
→ 옵션 1이 더 실용적
```

---

## 📊 현재 구현 상세

### **코드 위치:**

#### 1. YOLO 감지 ([src/detection.py:147-161](src/detection.py#L147-L161))
```python
def detect_tables(self, image_path: str) -> List[Dict]:
    """
    표 영역 전체를 하나의 객체로 감지
    개별 셀은 감지하지 않음
    """
    return self.detect(image_path, target_classes=["table"])

# 출력:
# [{"class": "table", "bbox": [x1, y1, x2, y2], "confidence": 0.95}]
```

#### 2. OCR 텍스트 추출 ([src/ocr.py:117-172](src/ocr.py#L117-L172))
```python
def extract_text_from_region(self, image_path, bbox):
    """
    YOLO가 감지한 표 영역에서 텍스트 + 좌표 추출
    """
    # 표 영역 크롭
    cropped = image[y1:y2, x1:x2]

    # OCR 수행
    results = self.reader.readtext(cropped)

    # 각 텍스트의 좌표 반환
    return [{
        "text": text,
        "center": [cx, cy],
        "bbox": [[x1,y1], [x2,y2], ...]
    }]
```

#### 3. 좌표 기반 구조 분석 ([src/ocr.py:220-277](src/ocr.py#L220-L277))
```python
def cluster_texts_by_line(text_data, y_threshold=10.0):
    """
    Y 좌표로 행 그룹화
    X 좌표로 정렬

    셀 경계는 좌표 분석으로 추정
    """
    # Y 좌표 클러스터링 → 행
    # X 좌표 정렬 → 열 순서
```

---

## ✅ 결론

### **현재 YOLO의 역할:**
```
❌ 개별 셀 감지 안함
✅ 표 영역 전체만 감지
✅ 셀 구조는 OCR 좌표로 추정
```

### **이 방식이 적합한 이유:**
1. **실용적** - 대부분의 정형 표에서 잘 작동 (85%)
2. **효율적** - 추가 학습 데이터 불필요
3. **빠름** - YOLO는 1번만 실행
4. **개선 가능** - 열 경계 알고리즘 추가로 95%까지 향상

### **개별 셀 감지가 필요한 경우:**
- 매우 불규칙한 표가 많을 때 (실제로는 드묾)
- 표 선도 없고 간격도 불규칙할 때
- → 이런 경우는 Table Transformer 같은 전용 모델 고려

---

## 💡 권장 사항

**현재 상태에서 개선:**
1. ✅ 현재 방식 유지 (YOLO 표 전체 감지)
2. ✅ 열 경계 알고리즘 추가 (헤더 기준 배정)
3. ✅ 실제 이미지로 테스트
4. ⏳ 필요시 Table Transformer 통합 검토

**YOLO 커스텀 학습으로 셀 감지:**
- ❌ 비추천 (비용 대비 효과 낮음)
- 대부분의 경우 불필요
